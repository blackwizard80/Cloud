<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cloud Web</title>
<style>
:root {
  /* Default Dark Theme (‡∂∏‡∑ô‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∑Ä‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑ö) */
  --bg-color: #111;
  --text-color: #fff;
  --online-bar-bg: #444;
  --me-bubble-bg: #0066ff;
  --not-me-bubble-bg: #444;
  --reply-text-color: #ccc;
  --input-bg-color: #fff;
  --input-text-color: #000;
  --send-bar-bg: #aaa;
  --button-color: #444;
  --button-hover-color: #555;
  --bubble-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}
body { margin:0; padding:0; background:var(--bg-color); color:var(--text-color); font-family:Arial, sans-serif;   transition: background 1s ease; }
#loginPage { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--bg-color); }
#onlineUsers,#messages,#sendMsg { display:none; }
#onlineUsers { position:fixed; top:0; left:0; width:100%; height:50px; background:var(--online-bar-bg); padding:10px; box-sizing:border-box; overflow-x:auto; white-space:nowrap; z-index:100; }
#messages { position:fixed; top:50px; left:0; width:100%; height:calc(100% - 170px); overflow-y:auto; padding:10px; box-sizing:border-box; }
#sendMsg { position:fixed; bottom:0; left:0; width:100%; background:var(--send-bar-bg); display:flex; flex-direction:column; align-items:center; padding:10px; box-sizing:border-box; }
#replyContext { width:100%; background:var(--online-bar-bg); color:var(--text-color); padding:5px; margin-bottom:5px; border-radius:5px; display:none; 
transform: scaleY(1);
    transform-origin: top;
    animation: slideDownIn 0.3s ease-out; }
#msgTxt { width:100%; height:40px; margin-bottom:10px; padding:10px; border:none; border-radius:5px; font-size:16px; box-sizing:border-box; background:var(--input-bg-color); color:var(--input-text-color); }
#msgBtn,#imgUploadBtn,#startRec,#stopRec { flex:1; height:40px; margin:5px 2px; background:var(--button-color); color:var(--input-bg-color); border:none; border-radius:5px; cursor:pointer; transition: background 0.2s ease;
}
#msgBtn:hover,
#imgUploadBtn:hover { background:var(--button-hover-color);
}
#stopRec:hover {
    background: #cc0000; /* Dark Red on hover */
}
.outer { display:flex; margin-bottom:10px; animation: fadeInSlide 0.4s ease-out; }
.me { background:var(--me-bubble-bg); color:var(--text-color); padding:10px; border-radius:10px; max-width:60%; text-align:right; margin-left:auto; animation: popInBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.notMe { background:var(--not-me-bubble-bg); color:var(--text-color); padding:10px; border-radius:10px; max-width:60%; text-align:left; margin-right:auto; animation: popInBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.imageMsg { max-width:100%; border-radius:10px; display:block; margin-top:5px; }
audio { margin-top:5px; max-width:100%; }
.time { font-size:0.8em; color:var(--reply-text-color); margin-top:5px; text-align:right; }
.me:hover, .notMe:hover {
    transform: translateY(-2px); /* 2px ‡∂â‡∑Ñ‡∑Ö‡∂ß ‡∂ë‡∑É‡∑Ä‡∑ì‡∂∏ */
    box-shadow: var(--bubble-shadow); /* ‡∂Ö‡∂≥‡∑î‡∂ª‡∑î ‡∑É‡∑ô‡∑Ä‡∂±‡∑ê‡∂Ω‡∑ä‡∂Ω‡∂ö‡∑ä */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.delete-btn,.reply-btn { display:inline-block; margin-top:5px; padding:5px; border:none; border-radius:5px; font-size:0.8em; cursor:pointer; }
.delete-btn { background:#ff4d4d; color:#fff; }
/* New CSS rule for hover state */
.delete-btn:hover {
    animation: jiggle 0.3s ease-in-out 2; /* 0.3s ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠ ‡∂Ø‡∑ô‡∑Ä‡∂ª‡∂ö‡∑ä ‡∑É‡∑ô‡∂Ω‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è */
}

.reply-btn { background:#007bff; color:#fff; }
#messages::-webkit-scrollbar { width:8px; }
#messages::-webkit-scrollbar-thumb { background:#444; border-radius:4px; }

/* Typing indicator bubble */
#typingIndicator {
display:none;
padding:8px 12px;
margin:5px;
background:var(--online-bar-bg);
border-radius:15px;
font-size:14px;
color:var(--reply-text-color);
width:fit-content;
animation: fadeIn 0.3s ease;
position: fixed;
top: 60px;
left: 12px;
z-index: 150;
}
.typing-text::after {
content: "";
animation: dots 1.5s steps(4, end) infinite;
}
@keyframes dots {
0%   { content:""; }
25%  { content:"."; }
50%  { content:".."; }
75%  { content:"..."; }
100% { content:""; }
}
@keyframes fadeIn {
from {opacity:0;}
to {opacity:1;}
}

/* Last seen bubble */
#lastSeenBubble {
position: fixed;
top: 8px;
right: 8px;
background: #007bff;
color: #fff;
font-size: 20px;
width: 42px;
height: 42px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
z-index: 200;
box-shadow: 0 0 10px rgba(0,0,0,0.3);
transition: transform 0.2s ease;
animation: spin 8s linear infinite;
}
#lastSeenBubble:hover { transform: scale(1.1); animation-duration: 1s; }

#lastSeenPopup {
display: none;
position: fixed;
top: 60px;
right: 8px;
background: #111;
color: #fff;
border-radius: 10px;
padding: 10px;
width: 250px;
max-height: 300px;
overflow-y: auto;
box-shadow: 0 0 15px rgba(0,0,0,0.4);
z-index: 300;
}
#lastSeenPopup h3 { margin: 0 0 10px; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 5px; }
#lastSeenPopup::-webkit-scrollbar { width: 6px; }
#lastSeenPopup::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

/* New Image Bubble */
#imageBubble {
position: fixed;
top: 60px;
right: 8px;
background: #28a745;
color: #fff;
font-size: 20px;
width: 42px;
height: 42px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
z-index: 210;
box-shadow: 0 0 10px rgba(0,0,0,0.3);
transition: transform 0.2s ease;
}
#imageBubble:hover { transform: scale(1.1); }

/* Image popup */
#imagePopup {
display: none;
position: fixed;
top: 120px;
right: 8px;
width: 300px;
height: 400px;
background: #111;
border-radius: 10px;
overflow: hidden;
z-index: 220;
box-shadow: 0 0 15px rgba(0,0,0,0.4);
}
#imagePopup iframe { width: 100%; height: 100%; border: none; }
#imagePopupClose {
position:absolute; top:5px; right:5px;
background:#ff4d4d; border:none; color:#fff; padding:3px 6px; border-radius:5px; cursor:pointer;
z-index: 230;
}
/* üíë Love Bubble */
#loveBubble {
  position: fixed;
  top: 60px;
  right: 60px;
  background: #ff1493;
  color: #fff;
  font-size: 24px;      /* icon size */
  width: 42px;
  height: 42px;
  line-height: 42px;    /* ‚ù§Ô∏è important */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;   /* extra safety */
  cursor: pointer;
  z-index: 210;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
  animation: heartbeat 2s infinite ease-in-out;
}
#loveBubble:hover { transform: scale(1.1); }

/* Emoji Popup */
#emojiPopup {
  display: none;
  position: fixed;
  top: 120px;
  right: 60px;
  background: #111;
  color: #fff;
  border-radius: 10px;
  padding: 10px;
  width: 200px;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 0 15px rgba(0,0,0,0.4);
  z-index: 220;
}
#emojiPopup h3 { margin-top:0; margin-bottom:10px; font-size:16px; }

/* Emoji Row */
.emojiRow {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.emojiBtn {
  background:#444;
  color:#fff;
  border:none;
  padding:3px 6px;
  border-radius:4px;
  cursor:pointer;
  font-size:0.9em;
}

/* Emoji Rain */
#emojiRainContainer {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  pointer-events:none;
  z-index:50;
}
.emojiDrop {
  position:absolute;
  font-size:24px;
  user-select:none;
  animation: fall linear infinite;
}
@keyframes fall {
  0% { transform: translateY(-50px); opacity:1; }
  100% { transform: translateY(100vh); opacity:0.7; }
}
@keyframes fadeInSlide {
  0% { 
    opacity: 0; 
    transform: translateY(15px); 
  }
  100% { 
    opacity: 1; 
    transform: translateY(0); 
  }
}
@keyframes popInBounce {
  0% { 
    transform: scale(0.8);
    opacity: 0; 
  }
  50% {
    transform: scale(1.05);
  }
  100% { 
    transform: scale(1);
    opacity: 1; 
  }
}
/* Heartbeat Animation */
@keyframes heartbeat {
  0% { transform: scale(1); }
  20% { transform: scale(1.1); }
  40% { transform: scale(1); }
  60% { transform: scale(1.15); }
  80% { transform: scale(1); }
  100% { transform: scale(1); }
}
/* Spin Animation */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
/* Pulse Effect for Media */
@keyframes mediaPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); } /* 2% ‡∂ö‡∑í‡∂±‡∑ä ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è */
  100% { transform: scale(1); }
}

/* New CSS class for image/audio elements */
.mediaMsgPulse {
    animation: mediaPulse 1.5s ease-in-out 2; 
}
/* Style ‡∂ö‡∑ú‡∂ß‡∑É‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± */

/* Login Button Click Animation */
#loginBtn:active {
    transform: scale(0.98); /* 2% ‡∂ö‡∑í‡∂±‡∑ä ‡∂ö‡∑î‡∂©‡∑è ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è */
    box-shadow: 0 0 5px rgba(0, 102, 255, 0.5); /* Shadow ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑è‡∂±‡∑Ä‡∑è */
    transition: transform 0.1s ease-out;
}

/* Jiggle/Shake effect for Delete button */
@keyframes jiggle {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-3px); }
  40%, 80% { transform: translateX(3px); }
}
/* #startRec CSS ‡∂ë‡∂ö‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± */
#startRec:hover {
    background: #008000; /* Dark Green on hover */
}
/* Style ‡∂ö‡∑ú‡∂ß‡∑É‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± */
.me:hover, .notMe:hover {
    transform: translateY(-2px); /* 2px ‡∂â‡∑Ñ‡∑Ö‡∂ß ‡∂ë‡∑É‡∑Ä‡∑ì‡∂∏ */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* ‡∂Ö‡∂≥‡∑î‡∂ª‡∑î ‡∑É‡∑ô‡∑Ä‡∂±‡∑ê‡∂Ω‡∑ä‡∂Ω‡∂ö‡∑ä */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
@keyframes slideDownIn {
    from { 
        transform: scaleY(0); 
        opacity: 0; 
    }
    to { 
        transform: scaleY(1); 
        opacity: 1; 
    }
}
/* üôà Theme Bubble (New CSS) */
#themeBubble {
  position: fixed;
  top: 112px; /* Love Bubble (60px) ‡∑Ä‡∂Ω‡∂ß ‡∂∫‡∂ß‡∑í‡∂±‡∑ä ‡∂≠‡∑ê‡∂∂‡∑ì‡∂∏‡∂ß, Image Bubble ‡∂ë‡∂ö‡∂ß ‡∑É‡∂∏‡∑è‡∂± ‡∂ã‡∑É‡∂ö‡∑í‡∂±‡∑ä */
  right: 60px; /* Love Bubble ‡∂ë‡∂ö‡∑ö (right: 60px) ‡∑Ä‡∂∏‡∂ß ‡∂≠‡∑ê‡∂∂‡∑ì‡∂∏‡∂ß 60px ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂± */
  background: #ff5722; /* Orange color for the bubble */
  color: #fff;
  font-size: 20px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 215; /* ‡∂Ö‡∂±‡∑ô‡∂ö‡∑î‡∂≠‡∑ä Bubbles ‡∑Ä‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∂â‡∑Ñ‡∑Ö‡∑í‡∂±‡∑ä ‡∂≠‡∂∂‡∂∏‡∑î */
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}
#themeBubble:hover { transform: scale(1.1); }

/* Theme Popup (New CSS) */
#themePopup {
  display: none;
  position: fixed; /* <-- ‡∂∏‡∑ô‡∂∫ ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑í! Popup ‡∂ë‡∂ö ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂≠‡∑ê‡∂±‡∂ö ‡∂≠‡∑ê‡∂∂‡∑ì‡∂∏‡∂ß */
  top: 160px; /* Bubble ‡∂ë‡∂ö‡∂ß ‡∂∫‡∂ß‡∑í‡∂±‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∂ß */
  right: 60px;
  background: #111;
  color: #fff;
  border-radius: 10px;
  padding: 10px;
  width: 200px;
  max-height: 400px; 
  overflow-y: auto;
  box-shadow: 0 0 15px rgba(0,0,0,0.4);
  z-index: 225;
}
.colorThemeRow { /* Theme List ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ô‡∂±‡∑î‡∂∏ */
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding: 5px;
  border-radius: 5px;
  transition: background 0.2s;
}
.colorThemeRow:hover {
    background: #222;
}
.themeToggleBtn {
  background: #444;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: 0.9em;
}
/* üõë Theme Popup Scrollbar Styles */
#themePopup::-webkit-scrollbar {
  width: 6px;
}

/* ‚≠ê Reaction Popup - Screen ‡∂∏‡∑ê‡∂Ø‡∂ß ‡∂ú‡∑ô‡∂± ‡∂í‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì */
#reactionPopup {
    display: none;
    position: fixed; 
    top: 50%;        
    left: 50%;       
    transform: translate(-50%, -50%); 
    background: #fff; 
    border-radius: 20px; 
    padding: 5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 350; 
}
.reaction-emoji {
    font-size: 28px; /* Emoji ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ú‡∂ö‡∑î ‡∂ö‡∂ª‡∂∫‡∑í */
    padding: 5px 10px;
    cursor: pointer;
    transition: transform 0.1s;
}
.reaction-emoji:hover {
    transform: scale(1.3); 
}

/* ‚≠ê Message Reaction Display - WhatsApp ‡∑Ä‡∂ú‡∑ö ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂¥‡∑ô‡∂±‡∑î‡∂∏‡∂ö‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì */
.reaction-container {
    position: absolute;
    bottom: -12px; 
    right: 0px;  
    background: #fff;
    border: 1px solid #ddd; 
    border-radius: 12px; 
    padding: 2px 6px;
    font-size: 14px; 
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    line-height: 1.2; 
    pointer-events: all; 
    cursor: pointer;
    transition: transform 0.1s;
    display: flex; 
    align-items: center;
}
.reaction-container:hover {
    transform: translateY(-3px) scale(1.05); 
}

/* ‚≠ê Reaction Count - Reaction Bubble ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠ ‡∂á‡∂≠‡∑í count ‡∂ë‡∂ö */
.reaction-count {
    color: #000;
    font-size: 10px; 
    margin-left: 2px;
    font-weight: bold;
    min-width: 10px; 
    text-align: center;
}

</style>
</head>
<body>

<!-- Login -->
<div id="loginPage">
<h1>Login</h1>
<input id="password" type="password" placeholder="Enter Password" style="padding:10px; width:80%; border-radius:5px; border:none; margin-bottom:12px;">
<button id="loginBtn" style="padding:10px; width:80%; background:#0066ff; color:#fff; border:none; border-radius:5px; cursor:pointer;">Login</button>
<p id="errorMsg" style="color:red; display:none; margin-top:10px;">Invalid password! Please try again.</p>
</div>

<!-- Chat UI -->
<div id="onlineUsers">Online Users: Loading...</div>
<div id="messages"></div>
<div id="typingIndicator"><span id="typingUser"></span><span class="typing-text">is typing</span></div>

<!-- Last seen -->
<div id="lastSeenBubble" title="View last seen">üïí</div>
<div id="lastSeenPopup">
<h3>Last Seen</h3>
<div id="lastSeenList">Loading...</div>
</div>

<!-- Image bubble -->
<div id="imageBubble" title="Open website">üñºÔ∏è</div>
<div id="imagePopup">
<button id="imagePopupClose">√ó</button>
<iframe src="https://blackwizard80.github.io/img/"></iframe>
</div>

<!-- Love Bubble -->
<div id="loveBubble" title="Emoji Rain">üë©‚Äç‚ù§Ô∏è‚Äçüë®</div>

<!-- Emoji Popup -->
<div id="emojiPopup">
  <h3>Emoji Rain</h3>
  <div id="emojiListContainer"></div>
</div>

<!-- Emoji Rain Container -->
<div id="emojiRainContainer"></div>
<div id="themeBubble" title="Change Theme">üé®</div>
<div id="reactionPopup">
  <span class="reaction-emoji" data-reaction="üëç">üëç</span>
  <span class="reaction-emoji" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</span>
  <span class="reaction-emoji" data-reaction="üòÇ">üòÇ</span>
  <span class="reaction-emoji" data-reaction="üòÆ">üòÆ</span>
  <span class="reaction-emoji" data-reaction="üò¢">üò¢</span>
  <span class="reaction-emoji" data-reaction="üôè">üôè</span>
</div>

<div id="themePopup">
  <h3>Select Theme</h3>
  <div id="colorThemeList"></div>
</div>

<!-- Send Message -->
<div id="sendMsg">
<div id="replyContext">
Replying to: <span id="replyMsg"></span>
<button id="cancelReply" style="background:#ff4d4d; border:none; color:#fff; padding:5px; border-radius:5px; float:right;">Cancel</button>
</div>
<input id="msgTxt" type="text" placeholder="Type your message here..." />
<div style="display:flex; width:100%;">
<button id="msgBtn">Send</button>
<button id="imgUploadBtn">Upload Image</button>
<button id="startRec">üé§</button>
<button id="stopRec">‚èπ</button>
</div>
<input id="imgUpload" type="file" accept="image/*" style="display:none;">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getDatabase, ref, set, remove, onChildAdded, onChildRemoved,
      onValue, onDisconnect, get, query, orderByKey, limitToLast, endAt
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwiuV6OxyXNK2A7_utfw8UdsuIbAfMgBI",
      authDomain: "blackhs.firebaseapp.com",
      databaseURL: "https://blackhs-default-rtdb.firebaseio.com",
      projectId: "blackhs",
      storageBucket: "blackhs.appspot.com",
      messagingSenderId: "849633201387",
      appId: "1:849633201387:web:facbd767e26664e01142ae"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const loginPage = document.getElementById("loginPage");
    const loginBtn = document.getElementById("loginBtn");
    const passwordInput = document.getElementById("password");
    const errorMsg = document.getElementById("errorMsg");
    const onlineUsersDiv = document.getElementById("onlineUsers");
    const messagesDiv = document.getElementById("messages");
    const msgTxt = document.getElementById("msgTxt");
    const msgBtn = document.getElementById("msgBtn");
    const imgUploadBtn = document.getElementById("imgUploadBtn");
    const imgUpload = document.getElementById("imgUpload");
    const replyContext = document.getElementById("replyContext");
    const replyMsg = document.getElementById("replyMsg");
    const cancelReply = document.getElementById("cancelReply");
    const startRec = document.getElementById("startRec");
    const stopRec = document.getElementById("stopRec");
    const typingIndicator = document.getElementById("typingIndicator");
    const typingUserSpan = document.getElementById("typingUser");
    const lastSeenBubble = document.getElementById("lastSeenBubble");
    const lastSeenPopup = document.getElementById("lastSeenPopup");
    const lastSeenList = document.getElementById("lastSeenList");
    const imageBubble = document.getElementById("imageBubble");
    const imagePopup = document.getElementById("imagePopup");
    const imagePopupClose = document.getElementById("imagePopupClose");
    const loveBubble = document.getElementById("loveBubble");
    const emojiPopup = document.getElementById("emojiPopup");
    const emojiListContainer = document.getElementById("emojiListContainer");
    const emojiRainContainer = document.getElementById("emojiRainContainer");   
    const themeBubble = document.getElementById("themeBubble");
    const themePopup = document.getElementById("themePopup");
    const colorThemeList = document.getElementById("colorThemeList");
    const root = document.documentElement; 
    
    // ‚≠ê Reaction Elements
    const reactionPopup = document.getElementById("reactionPopup");
    const reactionEmojis = document.querySelectorAll("#reactionPopup .reaction-emoji");

    let sender = null;
    let onlineRef = null;
    let replyTo = null;
    let oldestKey = null;
    let loadingOld = false;
    let mediaRecorder;
    let audioChunks = [];
    
    // ‚≠ê Reaction State Variables
    let currentMessageKey = null; 
    let pressTimer;
    let messageTarget;
    let popupTimeout; 


    themeBubble.style.display = "none"; 
    loveBubble.style.display = "none"; 
    emojiRainContainer.style.display = "none";
    imageBubble.style.display = "none";
    onlineUsersDiv.style.display = "none";
    messagesDiv.style.display = "none";
    document.getElementById("sendMsg").style.display = "none";

    loginBtn.addEventListener("click", () => {
      const password = passwordInput.value.trim();
      const correctPassword = "0759";

      if (password === correctPassword) {
        loginPage.style.display = "none";
        onlineUsersDiv.style.display = "block";
        messagesDiv.style.display = "block";
        document.getElementById("sendMsg").style.display = "block";
        themeBubble.style.display = "flex"; 
        imageBubble.style.display = "flex";
        loveBubble.style.display = "block"; 
        emojiRainContainer.style.display = "block";
         


        sender = sessionStorage.getItem("sender") || prompt("Enter your name:");
        sessionStorage.setItem("sender", sender);
        onlineRef = ref(db, "online/" + sender);
        set(onlineRef, { name: sender, isTyping: false, isRecording: false });

        // üïí Track last seen when user disconnects
        const lastSeenRef = ref(db, "lastSeen/" + sender);
        onDisconnect(onlineRef).remove();
        onDisconnect(lastSeenRef).set(new Date().toLocaleString());

        setupChat();
        loadInitialMessages();
      } else {
        errorMsg.style.display = "block";
      }
    });

    function setupChat() {
      onValue(ref(db, "online"), (snap) => {
        const users = snap.val() || {};
        const arr = Object.keys(users).map(k => {
          const u = users[k];
          let status = "";
          if (u.isRecording) {
            status = ' <span style="color:red;">‚óè</span> recording...';
          } else if (u.isTyping) {
            status = ' <span style="color:green;">‚óè</span> typing...';
          }
          return u.name + status;
        });
        onlineUsersDiv.innerHTML = "Online Users: " + (arr.length ? arr.join(", ") : "None");

        const typingUsers = Object.values(users).filter(u => u.isTyping && u.name !== sender);
        if (typingUsers.length > 0) {
          typingUserSpan.textContent = typingUsers[0].name;
          typingIndicator.style.display = "block";
        } else {
          typingIndicator.style.display = "none";
        }
      });

      msgTxt.addEventListener("input", () => {
        if (!onlineRef) return;
        set(onlineRef, { name: sender, isTyping: msgTxt.value.trim() !== "", isRecording: false });
      });

      msgBtn.addEventListener("click", () => {
        const text = msgTxt.value.trim();
        if (!text) return;
        const key = Date.now().toString();
        set(ref(db, "messages/" + key), {
          sender, msg: text, replyTo, type: "text", time: new Date().toLocaleString()
        });
        msgTxt.value = "";
        replyTo = null;
        replyContext.style.display = "none";
        set(onlineRef, { name: sender, isTyping: false, isRecording: false });
      });

      imgUploadBtn.addEventListener("click", () => imgUpload.click());
      imgUpload.addEventListener("change", () => {
        const file = imgUpload.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const key = Date.now().toString();
          set(ref(db, "messages/" + key), {
            sender, msg: reader.result, type: "image", time: new Date().toLocaleString()
          });
        };
        reader.readAsDataURL(file);
      });

      cancelReply.addEventListener("click", () => {
        replyTo = null;
        replyContext.style.display = "none";
      });

      messagesDiv.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const key = e.target.getAttribute("data-key");
          if (confirm("Delete this message?")) remove(ref(db, "messages/" + key));
        }
        if (e.target.classList.contains("reply-btn")) {
          const msg = e.target.getAttribute("data-msg");
          replyTo = msg;
          replyMsg.innerText = msg.length > 120 ? msg.slice(0,120) + "..." : msg;
          replyContext.style.display = "block";
        }
      });

      messagesDiv.addEventListener("scroll", () => {
        if (messagesDiv.scrollTop === 0 && !loadingOld && oldestKey) {
          loadMoreMessages();
        }
      });

      startRec.addEventListener("click", startRecording);
      stopRec.addEventListener("click", stopRecording);

      // üïí Bubble click => show last seen popup
      lastSeenBubble.addEventListener("click", async () => {
        if (lastSeenPopup.style.display === "block") {
          lastSeenPopup.style.display = "none";
          return;
        }
        lastSeenPopup.style.display = "block";

        const snap = await get(ref(db, "lastSeen"));
        const val = snap.val() || {};
        if (Object.keys(val).length === 0) {
          lastSeenList.innerHTML = "<p>No last seen data.</p>";
          return;
        }

        // Build list sorted by username
        let keys = Object.keys(val).sort((a,b)=> a.localeCompare(b));
        let html = "<ul style='list-style:none;padding:0;margin:0;'>";
        keys.forEach(u => {
          html += `<li style='margin-bottom:8px;'><b>${u}</b><br><small>${val[u]}</small></li>`;
        });
        html += "</ul>";
        lastSeenList.innerHTML = html;
      });

      // Close popup when clicking outside
      document.addEventListener("click", (e) => {
        if (!lastSeenPopup.contains(e.target) && e.target !== lastSeenBubble) {
          lastSeenPopup.style.display = "none";
        }
      });
      
      // ‚≠ê NEW Reaction Logic Start
      
      // 1. Emoji Reaction Buttons ‡∑Ä‡∂Ω‡∂ß Click Listener ‡∂ë‡∂ö
      reactionEmojis.forEach(emojiEl => {
          emojiEl.addEventListener("click", (e) => {
              e.stopPropagation(); // Stop event from propagating to document click listener
              if (currentMessageKey) {
                  sendReaction(currentMessageKey, emojiEl.getAttribute("data-reaction"));
              }
          });
      });

      // 2. Reaction Popup ‡∂ë‡∂ö ‡∂¥‡∑í‡∂ß‡∂≠ ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß ‡∂ë‡∂∫ ‡∑Ä‡∑É‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏
            // 2. Reaction Popup ‡∂ë‡∂ö ‡∂¥‡∑í‡∂ß‡∂≠ ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß ‡∂ë‡∂∫ ‡∑Ä‡∑É‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏
      document.addEventListener("click", (e) => {
          if (reactionPopup.style.display === "flex" && !reactionPopup.contains(e.target)) {
              // Message Bubble ‡∂ë‡∂ö ‡∂∏‡∂≠ ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
              if (!e.target.closest(".me, .notMe")) {
                   reactionPopup.style.display = "none";
                   // ‚≠ê NEW: Timeout ‡∂ë‡∂ö clear ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                   clearTimeout(popupTimeout); 
              }
          }
      });

      
      // 3. Long Press Event Handling (WhatsApp style)
      messagesDiv.addEventListener("mousedown", handleLongPressStart);
      messagesDiv.addEventListener("touchstart", handleLongPressStart); // Mobile support
      messagesDiv.addEventListener("mouseup", handleLongPressEnd);
      messagesDiv.addEventListener("touchend", handleLongPressEnd);
      messagesDiv.addEventListener("mousemove", handleLongPressEnd); // If mouse moves, cancel long press
      messagesDiv.addEventListener("touchmove", handleLongPressEnd);
      
      function handleLongPressStart(e) {
          // Only target message bubbles (me or notMe)
          const bubble = e.target.closest(".me, .notMe");
          if (!bubble) return;
          
          // Reply, Delete buttons ‡∂∏‡∂≠ long press ‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∑ê‡∑Ö‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏
          if (e.target.classList.contains("delete-btn") || e.target.classList.contains("reply-btn")) return;
          
          // Reaction Container ‡∂ë‡∂ö ‡∂∏‡∂≠ long press ‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∑ê‡∑Ö‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏
          if (e.target.closest(".reaction-container")) return; 

          messageTarget = bubble;

          // Clear any existing timer
          clearTimeout(pressTimer);
          
                    // 500ms (0.5s) long press delay ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
          pressTimer = setTimeout(() => {
              
              // Message Bubble ‡∂ë‡∂ö‡∑ö Key ‡∂ë‡∂ö ‡∑É‡∑ú‡∂∫‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
              currentMessageKey = messageTarget.closest(".outer").id; 

              // Popup ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í. CSS ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂ë‡∂∫ ‡∂∏‡∑ê‡∂Ø‡∂ß ‡∂ú‡∂±‡∑ì.
              reactionPopup.style.display = "flex"; 
              
              // ‚≠ê NEW: ‡∂≠‡∂≠‡∑ä‡∂¥‡∂ª 3‡∂ö‡∂ß ‡∂¥‡∑É‡∑î Popup ‡∂ë‡∂ö ‡∂â‡∂∂‡∑ö ‡∑Ä‡∑É‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß Timeout ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
              clearTimeout(popupTimeout); // ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∂≠‡∑í‡∂∂‡∑ñ timeout ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä clear ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
              popupTimeout = setTimeout(() => {
                  reactionPopup.style.display = "none";
              }, 3000); // 3000ms = ‡∂≠‡∂≠‡∑ä‡∂¥‡∂ª 3
              
          }, 500); 

      }

      function handleLongPressEnd() {
          clearTimeout(pressTimer);
      }
      // ‚≠ê NEW Reaction Logic End
      
    }

    // ‚≠ê NEW Function: Send Reaction
    function sendReaction(messageKey, emoji) {
        if (!sender) return;
              // 2. Reaction Popup ‡∂ë‡∂ö ‡∂¥‡∑í‡∂ß‡∂≠ ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß ‡∂ë‡∂∫ ‡∑Ä‡∑É‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏
      document.addEventListener("click", (e) => {
          if (reactionPopup.style.display === "flex" && !reactionPopup.contains(e.target)) {
              // Message Bubble ‡∂ë‡∂ö ‡∂∏‡∂≠ ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
              if (!e.target.closest(".me, .notMe")) {
                   reactionPopup.style.display = "none";
              }
          }
      });

        
        // Reaction ‡∂ë‡∂ö ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∑ö 'reactions/messageKey/sender' ‡∂∫‡∂ß‡∂≠‡∑ö‡∂∫
        const reactionRef = ref(db, "reactions/" + messageKey + "/" + sender);
        
        // ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂ë‡∂∏ emoji ‡∂ë‡∂ö‡∂∏ reaction ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ‡∂Ø‡∑ì ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä, ‡∂ë‡∂∫ ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Un-react)
        get(reactionRef).then(snap => {
            if (snap.exists() && snap.val().emoji === emoji) {
                remove(reactionRef);
            } else {
                // ‡∂±‡∑ê‡∂≠‡∑í‡∂±‡∂∏‡∑ä ‡∂±‡∑Ä reaction ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
                set(reactionRef, { emoji: emoji, user: sender });
            }
        });
        reactionPopup.style.display = "none";
    }

    function renderMessageAppend(key, data) {
      if (document.getElementById(key)) return;
      const isMe = data.sender === sender;
      const container = document.createElement("div");
      container.className = "outer";
      container.id = key;
      const inner = document.createElement("div");
      inner.className = isMe ? "me" : "notMe";
      
      // Reaction container ‡∂ë‡∂ö‡∂ß ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂ú‡∂≠ ‡∑Ä‡∑ì‡∂∏‡∂ß
      inner.style.position = "relative"; 

      if (data.replyTo) {
        const r = document.createElement("div");
        r.style.fontSize = "0.9em";
        r.style.color = "#aaa";
        r.textContent = "Replying to: " + data.replyTo;
        inner.appendChild(r);
      }

      const name = document.createElement("div");
      name.innerHTML = `<b>${data.sender}</b>`;
      inner.appendChild(name);

      if (data.type === "image") {
        const img = document.createElement("img");
        img.src = data.msg;
        img.className = "imageMsg";
        inner.appendChild(img);
      } else if (data.type === "audio") {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = data.msg;
        inner.appendChild(audio);
        inner.classList.add("mediaMsgPulse");
      } else {
        const msgdiv = document.createElement("div");
        msgdiv.innerHTML = data.msg;
        inner.appendChild(msgdiv);
      }

      const tdiv = document.createElement("div");
      tdiv.className = "time";
      tdiv.textContent = data.time || "";
      inner.appendChild(tdiv);

      const controls = document.createElement("div");
      if (isMe) {
        const del = document.createElement("button");
        del.className = "delete-btn";
        del.setAttribute("data-key", key);
        del.textContent = "Delete";
        controls.appendChild(del);
      }
      const rep = document.createElement("button");
      rep.className = "reply-btn";
      rep.setAttribute("data-msg", data.msg);
      rep.textContent = "Reply";
      controls.appendChild(rep);

      inner.appendChild(controls);
      container.appendChild(inner);
      messagesDiv.appendChild(container);

      // ‚≠ê NEW Reaction Display Logic
      const reactionDisplayRef = ref(db, "reactions/" + key);
      onValue(reactionDisplayRef, (snap) => {
          const reactions = snap.val() || {};
          const reactionKeys = Object.keys(reactions);
          
          // ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± reaction container ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
          let existingReaction = inner.querySelector(".reaction-container");
          if (existingReaction) {
              existingReaction.remove();
          }

          if (reactionKeys.length > 0) {
              // ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ reactions ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª, ‡∑Ä‡∑ê‡∂©‡∑í‡∂∏ reactions ‡∑É‡∂Ç‡∂õ‡∑ä‚Äç‡∂∫‡∑è‡∑Ä‡∂ö‡∑ä ‡∂á‡∂≠‡∑í emoji ‡∂ë‡∂ö ‡∑É‡∑ú‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±
              const emojiCounts = reactionKeys.reduce((acc, user) => {
                  const emoji = reactions[user].emoji;
                  acc[emoji] = (acc[emoji] || 0) + 1;
                  return acc;
              }, {});
              
              let topEmoji = null;
              let maxCount = 0;
              
              for (const emoji in emojiCounts) {
                  if (emojiCounts[emoji] > maxCount) {
                      maxCount = emojiCounts[emoji];
                      topEmoji = emoji;
                  }
              }
              
              if (topEmoji) {
                  const reactionContainer = document.createElement("div");
                  reactionContainer.className = "reaction-container";
                  
                  // Emoji ‡∂ë‡∂ö ‡∑É‡∑Ñ count ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
                  reactionContainer.innerHTML = `${topEmoji}<span class="reaction-count">${reactionKeys.length > 1 ? reactionKeys.length : ''}</span>`;
                  
                  // Reaction Container ‡∂ë‡∂ö‡∂ß Click Event ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∂ß)
                  reactionContainer.addEventListener("click", (e) => {
                      e.stopPropagation(); // Long press event ‡∂ë‡∂ö cancel ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß
                      
                      // ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è Simple Popup ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
                      const userList = reactionKeys.map(userKey => {
                          const userReaction = reactions[userKey].emoji;
                          return `${userKey}: ${userReaction}`;
                      }).join("\n");
                      
                      alert(`Reactions on this message:\n\n${userList}`);
                  });
                  
                  inner.appendChild(reactionContainer);
              }
          }
      });
      // ‚≠ê End Reaction Display Logic
    }

    async function loadInitialMessages() {
      const q = query(ref(db, "messages"), orderByKey(), limitToLast(10));
      const snap = await get(q);
      let arr = [];
      snap.forEach(child => arr.push({ key: child.key, val: child.val() }));
      arr.reverse();

      if (arr.length > 0) {
        oldestKey = arr[0].key;
        arr.forEach(item => renderMessageAppend(item.key, item.val));
        setTimeout(() => {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 50);
      }

      const messagesRef = ref(db, "messages");
      onChildAdded(messagesRef, (child) => {
        if (!document.getElementById(child.key)) {
          renderMessageAppend(child.key, child.val());
          setTimeout(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }, 30);
        }
      });

      onChildRemoved(messagesRef, (child) => {
        const el = document.getElementById(child.key);
        if (el) el.remove();
      });
    }

    async function loadMoreMessages() {
      if (!oldestKey) return;
      loadingOld = true;
      try {
        const q = query(ref(db, "messages"), orderByKey(), endAt(oldestKey), limitToLast(6));
        const snap = await get(q);
        let msgs = [];
        snap.forEach(child => {
          if (child.key !== oldestKey) msgs.push({ key: child.key, val: child.val() });
        });
        if (msgs.length > 0) {
          const newOldestKey = msgs[0].key;
          const prevScrollHeight = messagesDiv.scrollHeight;
          // render at top: we'll insert before first child for older ordering
          msgs.reverse().forEach(m => {
            if (!document.getElementById(m.key)) {
              const isMe = m.val.sender === sender;
              const container = document.createElement("div");
              container.className = "outer";
              container.id = m.key;
              const inner = document.createElement("div");
              inner.className = isMe ? "me" : "notMe";
              
              inner.style.position = "relative"; // Reaction container ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í

              if (m.val.replyTo) {
                const r = document.createElement("div");
                r.style.fontSize = "0.9em";
                r.style.color = "#aaa";
                r.textContent = "Replying to: " + m.val.replyTo;
                inner.appendChild(r);
              }

              const name = document.createElement("div");
              name.innerHTML = `<b>${m.val.sender}</b>`;
              inner.appendChild(name);

              if (m.val.type === "image") {
                const img = document.createElement("img");
                img.src = m.val.msg;
                img.className = "imageMsg";
                inner.appendChild(img);
                inner.classList.add("mediaMsgPulse"); 
              } else if (m.val.type === "audio") {
                const audio = document.createElement("audio");
                audio.controls = true;
                audio.src = m.val.msg;
                inner.appendChild(audio);
              } else {
                const msgdiv = document.createElement("div");
                msgdiv.innerHTML = m.val.msg;
                inner.appendChild(msgdiv);
              }

              const tdiv = document.createElement("div");
              tdiv.className = "time";
              tdiv.textContent = m.val.time || "";
              inner.appendChild(tdiv);

              const controls = document.createElement("div");
              if (isMe) {
                const del = document.createElement("button");
                del.className = "delete-btn";
                del.setAttribute("data-key", m.key);
                del.textContent = "Delete";
                controls.appendChild(del);
              }
              const rep = document.createElement("button");
              rep.className = "reply-btn";
              rep.setAttribute("data-msg", m.val.msg);
              rep.textContent = "Reply";
              controls.appendChild(rep);

              inner.appendChild(controls);
              container.appendChild(inner);

              if (messagesDiv.firstChild) messagesDiv.insertBefore(container, messagesDiv.firstChild);
              else messagesDiv.appendChild(container);
              
              // New: Old messages ‡∑Ä‡∂Ω‡∂ß‡∂≠‡∑ä reaction listener ‡∂ë‡∂ö ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (renderMessageAppend ‡∂≠‡∑î‡∑Ö‡∂∏ onValue ‡∂≠‡∑í‡∂∂‡∑ô‡∂± ‡∂±‡∑í‡∑É‡∑è)
              // Note: When inserting older messages, the logic in renderMessageAppend takes care of adding the reaction listener.
            }
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight - prevScrollHeight;
          oldestKey = newOldestKey;
        }
      } finally {
        loadingOld = false;
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        let options = { mimeType: "audio/webm;codecs=opus", bitsPerSecond: 128000 };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options = { mimeType: "audio/mp4", bitsPerSecond: 128000 };
        }

        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: options.mimeType });
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64Audio = reader.result;
            const key = Date.now().toString();
            set(ref(db, "messages/" + key), {
              sender, msg: base64Audio, type: "audio", time: new Date().toLocaleString()
            });
            set(onlineRef, { name: sender, isTyping: false, isRecording: false });
          };
          reader.readAsDataURL(blob);
        };
        mediaRecorder.start();
        set(onlineRef, { name: sender, isTyping: false, isRecording: true });
      } catch (err) {
        console.error("Recording error:", err);
        alert("Cannot start recording: " + (err.message || err));
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
    }

// ===== Add Image Bubble Functionality =====


imageBubble.addEventListener("click", () => {
imagePopup.style.display = imagePopup.style.display === "block" ? "none" : "block";
});
imagePopupClose.addEventListener("click", () => {
imagePopup.style.display = "none";
});

// Optional: click outside to close popup
document.addEventListener("click", (e) => {
if (!imagePopup.contains(e.target) && e.target !== imageBubble) {
imagePopup.style.display = "none";
}
});
// ===== Emoji Rain Setup =====


const emojis = ["‚ù§Ô∏è‚Äçü©π","ü•π","ü•∫","ü•∞","üòò","ü§§","üò°","üòö","üòô","üòÇ","ü©∑","‚ù§Ô∏è","üôÇ","üôÑ","üòí","ü´©","üíî","ü§®","üòë","üôÉ","üòå","ü©µ","üíô","üíö","üíõ","üß°"];

// Firebase ref for emoji rain states
const emojiRainRef = ref(db, "emojiRain");

// Toggle popup
loveBubble.addEventListener("click", () => {
  emojiPopup.style.display = emojiPopup.style.display === "block" ? "none" : "block";
});

// Build emoji list with on/off buttons
function renderEmojiList(state) {
  emojiListContainer.innerHTML = "";
  emojis.forEach(e => {
    const row = document.createElement("div");
    row.className = "emojiRow";
    const span = document.createElement("span");
    span.textContent = e;
    const btn = document.createElement("button");
    btn.className = "emojiBtn";
    const isOn = state[e] === true;
    btn.textContent = isOn ? "ON" : "OFF";
    btn.style.background = isOn ? "#28a745" : "#444";

    btn.addEventListener("click", () => {
      set(ref(db, "emojiRain/" + e), !isOn);
    });

    row.appendChild(span);
    row.appendChild(btn);
    emojiListContainer.appendChild(row);
  });
}

// Initial load & realtime update
onValue(emojiRainRef, snap => {
  const val = snap.val() || {};
  renderEmojiList(val);
  updateEmojiRain(val);
});

let activeEmojis = {};
function updateEmojiRain(state) {
  activeEmojis = {};
  for (let e of Object.keys(state)) {
    if (state[e]) activeEmojis[e] = true;
  }
  // Start rain
  startEmojiRain();
}

let rainInterval;
function startEmojiRain() {
  clearInterval(rainInterval);
  emojiRainContainer.innerHTML = "";

  const allActive = Object.keys(activeEmojis);
  if (allActive.length === 0) return;

  rainInterval = setInterval(() => {
    const e = allActive[Math.floor(Math.random() * allActive.length)];
    const span = document.createElement("div");
    span.className = "emojiDrop";
    span.textContent = e;
    span.style.left = Math.random() * 100 + "vw";
    span.style.fontSize = (20 + Math.random() * 20) + "px";
    span.style.animationDuration = (3 + Math.random() * 4) + "s";
    emojiRainContainer.appendChild(span);

    setTimeout(() => {
      span.remove();
    }, parseFloat(span.style.animationDuration) * 1000);
  }, 300); // every 300ms drop one emoji
}
// ===== Theme System Logic (New) =====

// Themes ‡∂±‡∑í‡∂ª‡∑ä‡∑Ä‡∂†‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
const themes = [
    {
        name: "Dark (Default)",
        id: "dark",
        colors: {
            "--bg-color": "#111",
            "--text-color": "#fff",
            "--online-bar-bg": "#444",
            "--me-bubble-bg": "#0066ff",
            "--not-me-bubble-bg": "#444",
            "--reply-text-color": "#ccc",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#aaa",
            "--button-color": "#444",
            "--button-hover-color": "#555",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.4)",
        }
    },
    {
        name: "Lovely ‚ù§Ô∏è",
        id: "lovely",
        colors: {
            "--bg-color": "#ffe8f2", 
            "--text-color": "#333",
            "--online-bar-bg": "#b36daa", 
            "--me-bubble-bg": "#ff69b4", 
            "--not-me-bubble-bg": "#f0f0f0", 
            "--reply-text-color": "#777",
            "--input-bg-color": "#fff",
            "--input-text-color": "#333",
            "--send-bar-bg": "#ffc1cc",
            "--button-color": "#ff69b4",
            "--button-hover-color": "#ff4d9a",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.2)",
        }
    },
    {
        name: "Sky ‚òÅÔ∏è",
        id: "sky",
        colors: {
            "--bg-color": "#e0f7fa", 
            "--text-color": "#004d40", 
            "--online-bar-bg": "#1a91bd", 
            "--me-bubble-bg": "#03a9f4", 
            "--not-me-bubble-bg": "#cfd8dc", 
            "--reply-text-color": "#546e7a",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#b2ebf2",
            "--button-color": "#03a9f4",
            "--button-hover-color": "#0398db",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.2)",
        }
    },
    {
        name: "Forest üå≥",
        id: "forest",
        colors: {
            "--bg-color": "#2e7d32", 
            "--text-color": "#e8f5e9", 
            "--online-bar-bg": "#3e9c75", 
            "--me-bubble-bg": "#aed581", 
            "--not-me-bubble-bg": "#388e3c", 
            "--reply-text-color": "#c8e6c9",
            "--input-bg-color": "#e8f5e9",
            "--input-text-color": "#000",
            "--send-bar-bg": "#4caf50",
            "--button-color": "#aed581",
            "--button-hover-color": "#9ccc65",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.3)",
        }
    },
    {
        name: "WhatsApp üü¢",
        id: "whatsapp",
        colors: {
            "--bg-color": "#ece5dd", 
            "--text-color": "#000",
            "--online-bar-bg": "#075e54", 
            "--me-bubble-bg": "#dcf8c6", 
            "--not-me-bubble-bg": "#fff", 
            "--reply-text-color": "#888",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#f0f0f0",
            "--button-color": "#075e54",
            "--button-hover-color": "#054a41",
            "--bubble-shadow": "0 1px 1px rgba(0, 0, 0, 0.1)",
        }
    },
    {
        name: "Neon üéÜ",
        id: "neon",
        colors: {
            "--bg-color": "#0d0128", 
            "--text-color": "#00ffff", 
            "--online-bar-bg": "#8a2be2", 
            "--me-bubble-bg": "#ff1493", 
            "--not-me-bubble-bg": "#8a2be2", 
            "--reply-text-color": "#ff00ff", 
            "--input-bg-color": "#220a46",
            "--input-text-color": "#00ffff",
            "--send-bar-bg": "#0d0128",
            "--button-color": "#ff1493",
            "--button-hover-color": "#cc0077",
            "--bubble-shadow": "0 0 15px rgba(255, 20, 147, 0.5)",
        }
    },
        {
        name: "Gold ‚ú®",
        id: "gold",
        colors: {
            "--bg-color": "#fff8e1",      
            "--text-color": "#333",       
            "--online-bar-bg": "#aba72c", 
            "--me-bubble-bg": "#ffc107",  
            "--not-me-bubble-bg": "#f5f5f5",
            "--reply-text-color": "#888",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#ffecb3",
            "--button-color": "#ffc107",
            "--button-hover-color": "#ffb300",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.2)",
        }
    },
    {
        name: "Ocean üåä",
        id: "ocean",
        colors: {
            "--bg-color": "#e3f2fd",      
            "--text-color": "#1565c0",    
            "--online-bar-bg": "#1a91bd", 
            "--me-bubble-bg": "#2196f3",  
            "--not-me-bubble-bg": "#bbdefb",
            "--reply-text-color": "#64b5f6",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#90caf9",
            "--button-color": "#2196f3",
            "--button-hover-color": "#1e88e5",
            "--bubble-shadow": "0 4px 8px rgba(0, 0, 0, 0.2)",
        }
    },
    {
        name: "Monochrome ‚ö´‚ö™",
        id: "mono",
        colors: {
            "--bg-color": "#f0f0f0",      
            "--text-color": "#333",       
            "--online-bar-bg": "#ccc",    
            "--me-bubble-bg": "#555",     
            "--not-me-bubble-bg": "#fff", 
            "--reply-text-color": "#777",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#ddd",
            "--button-color": "#333",
            "--button-hover-color": "#444",
            "--bubble-shadow": "0 1px 3px rgba(0, 0, 0, 0.2)",
        }
    },
        {
        name: "Telegram üü¶",
        id: "telegram",
        colors: {
            "--bg-color": "#f5f5f5",      
            "--text-color": "#000",       
            "--online-bar-bg": "#50a7e5", 
            "--me-bubble-bg": "#dcf8c6",  
            "--not-me-bubble-bg": "#fff", 
            "--reply-text-color": "#888",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#f0f0f0",   
            "--button-color": "#50a7e5",  
            "--button-hover-color": "#4096d2",
            "--bubble-shadow": "0 1px 1px rgba(0, 0, 0, 0.1)",
        }
    },
    {
        name: "iMessage üçè",
        id: "imessage",
        colors: {
            "--bg-color": "#f9f9f9",      
            "--text-color": "#000",       
            "--online-bar-bg": "#fff",    
            "--me-bubble-bg": "#59cf3c",  
            "--not-me-bubble-bg": "#e5e5ea",
            "--reply-text-color": "#888",
            "--input-bg-color": "#fff",
            "--input-text-color": "#000",
            "--send-bar-bg": "#f9f9f9",
            "--button-color": "#59cf3c",
            "--button-hover-color": "#45b82c",
            "--bubble-shadow": "0 1px 2px rgba(0, 0, 0, 0.05)",
        }
    },
{
    name: "Synthwave üíú",
    id: "synthwave",
    colors: {
        "--bg-color": "#1a003a",        
        "--text-color": "#f0f0ff",      
        "--online-bar-bg": "#5000a6",   
        "--me-bubble-bg": "#ff0099",    
        "--not-me-bubble-bg": "#00ffff",  
        "--reply-text-color": "#ffa500",
        "--input-bg-color": "#3a0050",  
        "--input-text-color": "#00ffff",
        "--send-bar-bg": "#5000a6",
        "--button-color": "#ff0099",
        "--button-hover-color": "#cc0077",
        "--bubble-shadow": "0 0 15px rgba(255, 0, 153, 0.6), 0 0 10px rgba(0, 255, 255, 0.6)",
    }
},
{
    name: "Cozy Coffee ü§é",
    id: "coffee",
    colors: {
        "--bg-color": "#e0d9c4",        
        "--text-color": "#3e2723",      
        "--online-bar-bg": "#795548",   
        "--me-bubble-bg": "#bcaaa4",    
        "--not-me-bubble-bg": "#f5f5f5",  
        "--reply-text-color": "#a1887f",
        "--input-bg-color": "#fff",     
        "--input-text-color": "#3e2723",
        "--send-bar-bg": "#d7ccc8",     
        "--button-color": "#8d6e63",    
        "--button-hover-color": "#6d4c41",
        "--bubble-shadow": "0 2px 4px rgba(0, 0, 0, 0.1)",
    }
},
{
    name: "Modern Green ü•ù",
    id: "flatgreen",
    colors: {
        "--bg-color": "#f1f8e9",        
        "--text-color": "#2e7d32",      
        "--online-bar-bg": "#4caf50",   
        "--me-bubble-bg": "#8bc34a",    
        "--not-me-bubble-bg": "#fff",     
        "--reply-text-color": "#aed581",
        "--input-bg-color": "#fff",
        "--input-text-color": "#000",
        "--send-bar-bg": "#e6ee9c",     
        "--button-color": "#4caf50",
        "--button-hover-color": "#388e3c",
        "--bubble-shadow": "0 1px 1px rgba(0, 0, 0, 0.1)",
    }
}


];

// Default theme ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
const defaultTheme = themes.find(t => t.id === "dark");
const themeRef = ref(db, "theme/currentThemeId");

// üé® Bubble click => show theme popup
themeBubble.addEventListener("click", () => {
    themePopup.style.display = themePopup.style.display === "block" ? "none" : "block";
});

// Build theme list and handle button clicks
function renderThemeList(activeThemeId) {
    colorThemeList.innerHTML = "";
    themes.forEach(theme => {
        const row = document.createElement("div");
        row.className = "colorThemeRow";

        const nameText = document.createElement("span");
        nameText.textContent = theme.name;
        
        const btn = document.createElement("button");
        btn.className = "themeToggleBtn";
        
        const isActive = activeThemeId === theme.id;
        btn.textContent = isActive ? "ACTIVE" : "SELECT";
        btn.style.background = isActive ? "#007bff" : "#444";
        
        btn.addEventListener("click", () => {
            if (isActive) {
                 // ‡∂Ø‡∑ê‡∂±‡∂ß active ‡∂±‡∂∏‡∑ä, Default theme ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
                set(themeRef, defaultTheme.id);
            } else {
                // ‡∂±‡∑Ä theme ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
                set(themeRef, theme.id); 
            }
            themePopup.style.display = "none";
        });

        row.appendChild(nameText);
        row.appendChild(btn);
        colorThemeList.appendChild(row);
    });
}

// Function to apply a theme
function applyTheme(theme) {
    if (!theme) theme = defaultTheme;
    // HTML root element ‡∂ë‡∂ö‡∑ö CSS variables ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    for (const [key, value] of Object.entries(theme.colors)) {
        root.style.setProperty(key, value);
    }
}


// Real-time theme update from Firebase
onValue(themeRef, snap => {
    const activeThemeId = snap.val() || defaultTheme.id; 
    
    // 1. Theme Object ‡∂ë‡∂ö ‡∑É‡∑ú‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±
    const activeTheme = themes.find(t => t.id === activeThemeId) || defaultTheme;

    // 2. Theme ‡∂ë‡∂ö apply ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ UI elements ‡∑Ä‡∂Ω ‡∑Ä‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑ö)
    applyTheme(activeTheme);

    // 3. Popup ‡∂ë‡∂ö render ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Active theme ‡∂ë‡∂ö ‡∂∂‡∑ê‡∂Ω‡∑ì‡∂∏‡∂ß)
    renderThemeList(activeThemeId);
});

// Click outside to close theme popup
document.addEventListener("click", (e) => {
    if (themePopup.style.display === "block" && !themePopup.contains(e.target) && e.target !== themeBubble) {
        themePopup.style.display = "none";
    }
});

</script>

</body>
</html>
